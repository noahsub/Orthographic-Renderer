////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// NavigationManager.cs
// This file contains the logic for managing navigation operations within the application
//
// Copyright (C) 2024 noahsub
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// IMPORTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System.Collections.Generic;
using System.Threading.Tasks;
using Avalonia.Controls;
using Orthographic.Renderer.Windows;
using Orthographic.Renderer.Interfaces;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// NAMESPACE
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
namespace Orthographic.Renderer.Managers;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// NAVIGATION MANAGER CLASS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

public static class NavigationManager
{
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // PAGES
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// <summary>
    /// The pages that can be navigated to.
    /// </summary>
    private static readonly Dictionary<string, UserControl?> Pages = new();

    /// <summary>
    /// The current page.
    /// </summary>
    private static UserControl? _currentPage;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // LOADING
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// <summary>
    /// Contains a dictionary of pages and whether they have been loaded.
    /// </summary>
    private static readonly Dictionary<string, bool> LoadedPages = new();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // NAVIGATION
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// <summary>
    /// Switches the page to the specified page.
    /// </summary>
    /// <param name="mainWindow">The main window.</param>
    /// <param name="pageName">The NavigationName of the page to switch to.</param>
    public static void SwitchPage(MainWindow mainWindow, string pageName)
    {
        var pageContent = mainWindow.FindControl<ContentControl>("PageContent");
        if (pageContent == null)
            return;

        if (!Pages.ContainsKey(pageName))
            return;

        if (Pages[pageName] == null)
        {
            // Page must already be created and registered with CreatePage
            return;
        }

        if (!LoadedPages[pageName])
        {
            LoadedPages[pageName] = true;
            (Pages[pageName] as dynamic)?.OnFirstLoad();
        }

        pageContent.Content = Pages[pageName];
        _currentPage = Pages[pageName];
        (Pages[pageName] as dynamic)?.OnNavigatedTo();
    }

    /// <summary>
    /// Registers a page instance.
    /// </summary>
    /// <param name="page">The page instance implementing IPage.</param>
    public static async Task CreatePage(IPage page)
    {
        var pageKey = page.NavigationName;
        Pages[pageKey] = page as UserControl;
        LoadedPages[pageKey] = false;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // GETTERS
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    /// <summary>
    /// Gets the current page.
    /// </summary>
    /// <returns></returns>
    public static UserControl? GetCurrentPage() => _currentPage;

    /// <summary>
    /// Gets the specified page.
    /// </summary>
    /// <param name="name">The name of the page to get.</param>
    /// <returns></returns>
    public static Control? GetPage(string name) =>
        Pages.ContainsKey(name) ? Pages[name] : new Control();
}
